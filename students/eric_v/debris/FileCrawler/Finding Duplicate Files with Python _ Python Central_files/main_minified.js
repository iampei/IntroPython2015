function initMembers(){printLogs("Start init  members");try{smMembers.docReferrer=getShortString(encodeURIComponent(document.referrer),sminternalconfig.maxParamSize)}catch(e){printErrors("Error while init smdocReferrer. "+e),smMembers.docReferrer="undefined"}try{smMembers.topLocation=getShortString(encodeURIComponent(top.location.href),sminternalconfig.maxParamSize)}catch(e){printErrors("Error while init topLocation. "+e),smMembers.topLocation="undefined"}try{smAppMacros.reportUrl=getShortString(smAppMacros.reportUrl,sminternalconfig.maxParamSize)}catch(e){printErrors("Error while init reportUrl. "+e),smAppMacros.reportUrl="undefined"}try{smcounters.flash=getFlashVersion(),getFlashVersion().split(",").shift()<12&&(smcounters.serveFlash=0)}catch(e){SMreportEvent("LOGIC_ERROR","General exception in get flash/chrome function. using default. Error="+e,100),smcounters.flash=0,smcounters.serveFlash=0}try{smoperational.hftUrl="http"+smconfig.prefix+"://selectmedia"+smconfig.server+".appspot.com/sm.evt",smoperational.eventUrl="http"+smconfig.prefix+"://selectmedia"+smconfig.server+".appspot.com/sm.hft"}catch(e){printErrors("Error while init url. "+e)}try{smMembers.docWidth=window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth,smMembers.smdocHeight=window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight}catch(e){printErrors("Error while get width and height. "+e)}}function printLogs(e){sminternalconfig.logs&&console.log(e)}function printErrors(e){sminternalconfig.logs&&console.error(e)}function getShortString(e,r){return e.length>=r&&(e=e.substring(0,r-3),e+="EOS"),e}function getFlashVersion(){try{try{var e=new ActiveXObject("ShockwaveFlash.ShockwaveFlash.6");try{e.AllowScriptAccess="always"}catch(r){return"6,0,0"}}catch(r){}return new ActiveXObject("ShockwaveFlash.ShockwaveFlash").GetVariable("$version").replace(/\D+/g,",").match(/^,?(.+),?$/)[1]}catch(r){try{if(navigator.mimeTypes["application/x-shockwave-flash"].enabledPlugin)return(navigator.plugins["Shockwave Flash 2.0"]||navigator.plugins["Shockwave Flash"]).description.replace(/\D+/g,",").match(/^,?(.+),?$/)[1]}catch(r){}}return"0,0,1"}function getChromeVersion(){try{var e=navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./);return e?parseInt(e[2],10):1}catch(r){return 1}}function smUnblockLogic(){try{getChromeVersion()>44&&(smoperational.checkForBlockInterval=setInterval(isJWFlagFlashBlocked,500))}catch(e){0==smcounters.flashErrors&&(SMreportEvent("LOGIC_ERROR","failed smUnblockLogic function err="+e,100),smcounters.flashErrors++),printErrors("failed smUnblockLogic function err="+e)}}function isJWFlagFlashBlocked(){try{var e=document.getElementsByClassName("jw-flag-flash-blocked");e.length>0&&(document.getElementById("sm_player").style.width="400px",document.getElementById("sm_player").style.height="300px",smoperational.IntervalOfJWUnblocked=setInterval(isJWFlagFlashBlockedCanceled,10))}catch(r){try{clearInterval(smoperational.checkForBlockInterval)}catch(r){printErrors("failed isJWFlagFlashBlocked function err="+r)}0==smcounters.flashErrors&&(SMreportEvent("LOGIC_ERROR","failed isJWFlagFlashBlocked function err="+r,100),smcounters.flashErrors++),printErrors("failed isJWFlagFlashBlocked function err="+r)}}function isJWFlagFlashBlockedCanceled(){try{var e=document.getElementsByClassName("jw-flag-flash-blocked");0==e.length&&(document.getElementById("sm_player").style.width=smSetupJsonObject.width+"px",document.getElementById("sm_player").style.height=smSetupJsonObject.height+"px",clearInterval(smoperational.IntervalOfJWUnblocked))}catch(r){try{clearInterval(smoperational.checkForBlockInterval),clearInterval(smoperational.IntervalOfJWUnblocked)}catch(r){printErrors("failed isJWFlagFlashBlockedCanceled function err="+r)}0==smcounters.flashErrors&&(SMreportEvent("LOGIC_ERROR","failed isJWFlagFlashBlockedCanceled function err="+r,100),smcounters.flashErrors++),printErrors("failed isJWFlagFlashBlockedCanceled function err="+r)}}function smsetMute(){try{jwplayer("sm_player")&&smoperational.isReady&&jwplayer("sm_player").setMute(!0)}catch(e){smcounters.muteError++,smcounters.muteError<2&&(printErrors("Failed execute setMute to true on jwplayer ","Error="+e),SMreportEvent("LOGIC_ERROR","General exception in setMute function. Error="+e,100))}}function smstartMute(){try{jwplayer("sm_player")&&smoperational.isReady&&(smoperational.timer=setInterval(smsetMute,100))}catch(e){printErrors("Failed execute setInterval function to call setMute ","Error="+e),SMreportEvent("LOGIC_ERROR","General exception in startMute function while starting interval. Error="+e,100)}}function smstopMute(){try{jwplayer("sm_player")&&smoperational.isReady&&clearTimeout(smoperational.timer)}catch(e){printErrors("Failed execute clearTimeout function to stop setMute ","Error="+e),SMreportEvent("LOGIC_ERROR","General exception in stopMute while clearTimeout. Error="+e,100)}}function SMreportEvent(e,r,t){try{var s="",o=smoperational.lastEvent,a="",n="",i="",l="";try{i=Math.round(((new Date).getTime()-smcounters.lastEventTS)/100)/10;var m=Math.round(((new Date).getTime()-smoperational.startTime)/100)/10;n="s:"+smoperational.loopnumber+" init_ts:"+m+",_w="+smMembers.docWidth+",_h="+smMembers.smdocHeight,smcounters.lastTag&&null==smoperational.adTagId&&(n=n+" No_tag="+encodeURIComponent(smcounters.lastTag)),smoperational.adTagId&&(l="("+smoperational.adTagId+")"),smcounters.eventsSentLog=smcounters.eventsSentLog+e+l+":"+m+",",a=smcounters.eventsSentLog,s=encodeURIComponent(r)}catch(c){s="",printErrors("Error while msg:"+c)}if(n=getShortString(n,2*sminternalconfig.maxParamSize),r=getShortString(r,2*sminternalconfig.maxParamSize),smoperational.randomNumber=Math.floor(100*Math.random()),smoperational.randomNumber<t){var p=smoperational.hftUrl+"?eventType="+e+"&placementId="+smAppMacros.placementId+"&campaignId="+smAppMacros.campaignId+"&samplingPercent="+t+"&price="+smAppMacros.price+"&PUBLISHER_ID="+smAppMacros.publisherId+"&BID_PRICE="+smAppMacros.bidPrice+"&ECP="+smAppMacros.ecp+"&randomNumber="+smoperational.randomNumber+"&breakIndex="+smoperational.breakIndex+"&smTagId="+smoperational.adTagId+"&sellerId="+smAppMacros.sellerId+"&hftResponseType="+smoperational.hftResponseType+"&smcreativeid="+smAppMacros.creativeId+"&tagPriority="+smoperational.tagPriority+"&smserveflash="+smcounters.serveFlash+"&smssl="+smconfig.ssl+"&appNexusURL="+smAppMacros.reportUrl+"&clientVersion="+smconfig.clientVersion+"&waterfallString="+smoperational.waterfallStr+"&reporturl="+smMembers.reportUrl+"&sessionId="+smoperational.sessionId+"&docReferrer="+smMembers.docReferrer+"&topLocation="+smMembers.topLocation+"&cb="+smAppMacros.cacheBuster+"&smwidth="+smSetupJsonObject.width+"&smheight="+smSetupJsonObject.height+"&message="+s+"&smdynamic1="+o+"&smdynamic3="+n+"&smdynamic4="+i+"&smdynamic2="+a;smCallURL(p)}smcounters.lastEventTS=(new Date).getTime(),smoperational.lastEvent=e}catch(c){printErrors("Error while report event. event="+e+", msg="+r+", sampling="+t+", randomNumber="+smoperational.randomNumber+", error="+c)}}function smGetPramFromUrl(e,r){for(var t=null,s=e.split("&"),o=0;o<s.length;o++){var a=s[o].split("=");if(a[0].indexOf("?")>=0&&(a[0]=a[0].substring(a[0].indexOf("?")+1)),a[0]==r){t=a[1];break}}return printLogs("smAdId at smGetTagIdFromJW"+smoperational.adTagId),t}function smGetTagIdFromJW(e){try{smSetTagMembersFromId(smGetPramFromUrl(e,"sm_tagid"),e)}catch(r){printErrors("Error running smGetTagIdFromJW. "+r),SMreportEvent("LOGIC_ERROR","Failed function smGetTagIdFromJW. Error="+r,100)}}function smSetTagMembersFromId(e,r){try{printLogs("breakIndex pre "+smoperational.breakIndex),smoperational.breakIndex=Math.floor(jwplayer("sm_player").getPosition()),smoperational.breakIndex=smoperational.breakIndex||0,printLogs("breakIndex "+smoperational.breakIndex)}catch(t){smoperational.breakIndex=-1}try{smoperational.adTagId=e,smcounters.lastTag=r,smoperational.tagPriority=smTagsObjects[smoperational.adTagId].order,smMembers.reportUrl=getShortString(smTagsObjects[smoperational.adTagId].repUrl,sminternalconfig.maxParamSize)}catch(t){smoperational.tagPriority=0,smMembers.reportUrl="","STATIC"!==smoperational.hftResponseType&&SMreportEvent("LOGIC_ERROR","Failed function smSetTagMembersFromId. "+t+" ,smTagsObjects: "+smTagsObjects,100)}}function smCallURL(e){printLogs("Start sending request: "+e);try{var r=e;r=getShortString(r,sminternalconfig.maxUrlSize);var t=document.createElement("script");t.type="text/javascript",t.async=!0,t.src=r;var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s),printLogs("Finished sending request: "+e)}catch(o){printErrors("Error while get smCallURL , url: "+e+", error: "+o)}}function getHftResponseFromServer(){var e=smoperational.eventUrl+"?placementId="+smAppMacros.placementId+"&campaignId="+smAppMacros.campaignId+"&responseType="+smconfig.responseType+"&price="+smAppMacros.price+"&BID_PRICE="+smAppMacros.bidPrice+"&ECP="+smAppMacros.ecp+"&sellerId="+smAppMacros.sellerId+"&PUBLISHER_ID="+smAppMacros.publisherId+"&smcreativeid="+smAppMacros.creativeId+"&smserveflash="+smcounters.serveFlash+"&smssl="+smconfig.ssl+"&docReferrer="+smMembers.docReferrer+"&topLocation="+smMembers.topLocation+"&clientVersion="+smconfig.clientVersion+"&randomNumber="+smoperational.randomNumber+"&appNexusURL="+smAppMacros.reportUrl;smCallURL(e)}function smuploadJWPlayer(){var e="http"+smconfig.prefix+"://cloud.selectmedia.asia/jwplayer/7.1.4/jwplayer.js";smCallURL(e)}function buildJWSetupObject(e){var r=1,t=0,s=0,o=60;smWaterfallArr=[];try{for(var a=0;a<e.tagList.length;a++)smWaterfallArr[a]=e.tagList[a].tagUrl,smTagsObjects[e.tagList[a].id]=e.tagList[a];printLogs(smTagsObjects),printLogs(smWaterfallArr),smSetupJsonObject.width=e.width,smSetupJsonObject.height=e.height,smSetupJsonObject.file=e.video,smSetupJsonObject.title=e.title,smSetupJsonObject.description=e.title,smSetupJsonObject.primary=e.type,smSetupJsonObject.autostart=e.autostart,smSetupJsonObject.mute=!e.sound,smSetupJsonObject.repeat=e.isRepeated,r=e.pre,t=e.mid,s=e.post,o=e.video_length;var n=Math.round(o/(t+1));smavdblock={};var i=1;if(r>0&&(smavdblock.adbreak1={},smavdblock.adbreak1.offset="pre",smavdblock.adbreak1.tag=smWaterfallArr,i++),r>1&&smoperational.randomNumber<sminternalconfig.preRollPercentage)for(var a=1;r-1>=a;a++){var l="adbreak"+i;i++,smavdblock[l]={},smavdblock[l].offset=a,smavdblock[l].tag=smWaterfallArr}if(t>0)for(var a=1;t>=a;a++){var l="adbreak"+i;smavdblock[l]={},smavdblock[l].offset=a*n,smavdblock[l].tag=smWaterfallArr,i++}s>0&&(l="adbreak"+i,smavdblock[l]={},smavdblock[l].offset="post",smavdblock[l].tag=smWaterfallArr),smoperational.hftResponseType=e.responseType,smoperational.sessionId=e.sessionId,smoperational.waterfallStr=e.waterfallId}catch(m){printErrors("Error running buildJWSetupObject. "+m),SMreportEvent("LOGIC_ERROR","Failed function buildJWSetupObject. Error="+m,100)}printLogs("smSetupJsonObject"),printLogs(smSetupJsonObject)}function parseHftResponseEvent(e){var r="";try{r=e.responseStatus,printLogs("Got HFT event from server. Start parsing HFT response. Status="+r),"OK"==r?(buildJWSetupObject(e),smoperational.myInterval=setInterval(function(){loadJWPlayer()},100)):(printErrors("Got error from HFT server. loading defaults"),SMreportEvent("LOGIC_ERROR","Failed to parse erver HFT response. Status="+r,100)),printLogs("Finished parse server HFT response. Status="+r)}catch(t){printErrors("Exception while parsing server HFT response. loading defaults. "+t),SMreportEvent("LOGIC_ERROR","Failed to parse erver HFT response. err="+t,100)}printLogs("Start init JW player immediately after getting response from server")}function loadJWPlayer(){if(smoperational.isReadyInProgress===!1)if(smoperational.isReadyInProgress=!0,smoperational.isReady===!1)try{jwplayer("sm_player")&&(0==smcounters.cdnCheck&&SMreportEvent("CDN_CHECK",smcounters.loadAttempts,10),smcounters.cdnCheck++,initJwPlayer(),clearInterval(smoperational.myInterval),printLogs("jwisobject is existing, start init JW"))}catch(e){printLogs("jwisobject not existing"),smcounters.loadAttempts++}finally{smoperational.isReadyInProgress=!1}else clearInterval(smoperational.myInterval),smoperational.isReadyInProgress=!1}function smEndMovie(){try{smoperational.loopnumber++,jwplayer("sm_player").remove(),initJwPlayer()}catch(e){SMreportEvent("LOGIC_ERROR","Error while executing smEndMovie. err: "+e,100)}}function initJwPlayer(){smjwplayer=jwplayer("sm_player"),jwplayer.key="MyAjvQ2hxCYRjETRZqJ8Wq0dtb0Cpt2Y9ArqWw==",smSetupJsonObject.advertising={client:"vast"},smSetupJsonObject.advertising.schedule=smavdblock,smjwplayer.setup(smSetupJsonObject),smjwplayer.on("ready",function(e){smoperational.isReady=!0;var r=e.setupTime,t="",s="";try{t=smjwplayer.getProvider().name}catch(o){printErrors("Error while onReady event. "+o),t=""}try{s=smjwplayer.getContainer().id}catch(o){printErrors("Error while onReady event. "+o),s=""}0==smoperational.loopnumber&&SMreportEvent("LOAD","loadAttempts="+smcounters.loadAttempts+" ,setupTime="+r+"_playerMode="+t+"_playerContainer_"+s,100),smjwplayer.setVolume(1e-5),smjwplayer.setMute(!0),smUnblockLogic()}),smjwplayer.on("setupError",function(e){SMreportEvent("SETUP_ERROR",e.message,100)}),smjwplayer.on("error",function(e){SMreportEvent("PLAYER_ERROR",e.message,100)}),smjwplayer.on("fullscreen",function(e){SMreportEvent("FULL_SCREEN",e.fullscreen,100)}),smjwplayer.on("displayClick",function(e){var r=smjwplayer.getState();"playing"==r?smjwplayer.play(!1):smjwplayer.play(!0),1==sminternalconfig.logs&&console.log(e)}),smjwplayer.on("tabFocus",function(e){1==sminternalconfig.logs&&console.log(e)}),smjwplayer.on("adError",function(e){var r=smoperational.adTagId;smGetTagIdFromJW(e.tag),smoperational.adErrorMessage=e.message,smcounters.AdError++,"IMPRESSION"==smoperational.lastEvent&&smoperational.adErrorMessage.indexOf("communication")>-1&&SMreportEvent("AD_CANCEL","",100),smstopMute(),r==smoperational.adTagId?SMreportEvent("AD_ERROR",e.message,10):SMreportEvent("TEST_AD","Tag ID:"+smoperational.adTagId+" fucked tag:"+r+" during timeout feature",10)}),smjwplayer.on("adImpression",function(e){var r="";try{smjwplayer.setControls(!1),smoperational.shouldSendOnAdTime=!0,smGetTagIdFromJW(e.tag),smstartMute(),smcounters.Impressions++}catch(t){r="error in impression event:"+t}var s="",o="";try{s=e.adsystem,o=e.creativetype}catch(t){printErrors(t),r="error in impression event:"+t}SMreportEvent("IMPRESSION",r+"creativeType:"+o+" ,adsystem: "+s,100)}),smjwplayer.on("adStarted",function(e){smGetTagIdFromJW(e.tag);var r="",t="";try{r=e.adsystem,t=e.creativetype}catch(s){printErrors(s)}SMreportEvent("AD_PLAY","creativeType:"+t+" ,adsystem: "+r,100)}),smjwplayer.on("adRequest",function(e){smGetTagIdFromJW(e.tag),smcounters.Requests++,SMreportEvent("AD_REQUEST","",10)}),smjwplayer.on("adSkipped",function(e){smGetTagIdFromJW(e.tag),SMreportEvent("AD_SKIP","",100)}),smjwplayer.on("adTime",function(e){smjwplayer.setControls(!1),e.position>1&&1==smoperational.shouldSendOnAdTime&&(smGetTagIdFromJW(e.tag),SMreportEvent("AD_VERIFY","_position:"+e.position,100),smoperational.shouldSendOnAdTime=!1)}),smjwplayer.on("adPause",function(e){smGetTagIdFromJW(e.tag),SMreportEvent("AD_PAUSE","_oldstate:"+e.oldstate,100)}),smjwplayer.on("beforePlay",function(e){smjwplayer.setControls(!1)}),smjwplayer.on("buffer",function(e){var r=e.reason;"stalled"!=r&&"error"!=r||0!=smoperational.bufferSend||(SMreportEvent("LOGIC_ERROR","buffer failed, reason: "+r,100),smoperational.bufferSend=!0)}),smjwplayer.on("adClick",function(e){smjwplayer.setControls(!0),smGetTagIdFromJW(e.tag),SMreportEvent("AD_CLICK","",100)}),1==sminternalconfig.logs&&smjwplayer.on("all",function(e){1==sminternalconfig.logs&&console.log(e)}),smjwplayer.on("play",function(e){smjwplayer.setControls(!1)}),smjwplayer.on("complete",function(e){SMreportEvent("TEST_PUB","Request="+smcounters.Requests+" ,Impression="+smcounters.Impressions+" ,Complete="+smcounters.Complete+" ,AdError="+smcounters.AdError,50),smEndMovie()}),smjwplayer.on("adComplete",function(e){smoperational.shouldSendOnAdTime=!1,smjwplayer.setControls(!1),smGetTagIdFromJW(e.tag),smstopMute(),smcounters.Complete++,SMreportEvent("COMPLETE","",100)})}var smMainClientVersion="2.0.0.4";if(smconfig)smconfig.clientVersion=smMainClientVersion+smconfig.clientVersion;else{var smconfig={server:"qa",ssl:0,clientVersion:smMainClientVersion,responseType:"",prefix:""};1==smconfig.ssl&&(smconfig.prefix="s")}if(!smAppMacros)var smAppMacros={reportUrl:"",placementId:"",campaignId:"1",price:"0",sellerId:"1",publisherId:"1",bidPrice:"0",ecp:"0",cacheBuster:"1",creativeId:"1",reservePrice:"0"};var sminternalconfig={logs:!1,maxParamSize:300,maxUrlSize:2e3,preRollPercentage:20},smoperational={loopnumber:0,lastEvent:"",isReady:!1,isReadyInProgress:!1,myInterval:-1,startTime:(new Date).getTime(),randomNumber:Math.floor(100*Math.random()),adTagId:null,tagPriority:0,waterfallStr:"",shouldSendOnAdTime:!1,timer:null,hftResponseType:"",eventUrl:"",hftUrl:"",sessionId:"",adErrorMessage:"",bufferSend:!1,checkForBlockInterval:0,IntervalOfJWUnblocked:0},smcounters={loadAttempts:0,breakIndex:0,lastTag:"",lastEventTS:(new Date).getTime(),eventsSentLog:"",muteError:0,Impressions:0,Requests:0,Complete:0,AdError:0,flash:0,serveFlash:1,cdnCheck:0,flashErrors:0},smMembers={reportUrl:"",docReferrer:"",topLocation:"",docWidth:0,smdocHeight:0},smavdblock={},smTagsObjects={},smSetupJsonObject={},smWaterfallArr=[];try{printLogs("*** Start SelectMedia main script ***"),smuploadJWPlayer(),initMembers(),SMreportEvent("PRE_INIT","reservePrice: "+smAppMacros.reservePrice,100),getHftResponseFromServer(),printLogs("*** Finished SelectMedia main script ***")}catch(err){printErrors("Error while executing SelectMedia main script. "+err),SMreportEvent("LOGIC_ERROR","Error while executing SelectMedia main script. "+err,100)}